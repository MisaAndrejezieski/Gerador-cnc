"""
Testes para o m√≥dulo Visualizador3D

Testes unit√°rios e de integra√ß√£o para garantir o funcionamento correto
do visualizador 3D de G-code.
"""

import unittest
import sys
import os
import tempfile

# Configura caminho para importar m√≥dulos do projeto
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

try:
    from gerador_analisador.visualizador_3d import Visualizador3D
    VISUALIZADOR_DISPONIVEL = True
except ImportError as e:
    print(f"‚ö†Ô∏è Aviso: Visualizador3D n√£o dispon√≠vel para testes: {e}")
    VISUALIZADOR_DISPONIVEL = False

@unittest.skipIf(not VISUALIZADOR_DISPONIVEL, "Visualizador3D n√£o dispon√≠vel")
class TestVisualizador3D(unittest.TestCase):
    """
    Casos de teste para a classe Visualizador3D.
    
    Testa funcionalidades de parsing, visualiza√ß√£o e tratamento de erros.
    """
    
    def setUp(self):
        """Configura ambiente de teste antes de cada caso."""
        self.gcode_basico = """
G21 ; Unidades em mil√≠metros
G90 ; Posicionamento absoluto
G0 X0 Y0 Z5 ; Movimento r√°pido para posi√ß√£o inicial
G1 Z0 F1000 ; Descida para altura de trabalho
G1 X10 Y0 Z0 ; Movimento de trabalho
G1 X10 Y10 Z2 ; Movimento com varia√ß√£o de Z
G1 X0 Y10 Z0 ; Retorno
G1 X0 Y0 Z0 ; Volta ao in√≠cio
G0 Z5 ; Retorna para altura segura
M30 ; Fim do programa
"""
        
        self.gcode_complexo = """
G21
G90
G0 X0 Y0 Z10
G1 Z0 F500
G1 X20 Y0 Z0
G1 X20 Y15 Z1
G1 X0 Y15 Z0
G1 X0 Y0 Z0
G0 X-5 Y-5 Z10
G1 Z0
G1 X25 Y-5 Z0
G1 X25 Y20 Z2
G1 X-5 Y20 Z0
G1 X-5 Y-5 Z0
G0 Z10
M30
"""
    
    def test_parse_gcode_basico(self):
        """Testa parsing de G-code b√°sico com movimentos mistos."""
        visualizador = Visualizador3D(None)
        coordenadas = visualizador.parse_gcode(self.gcode_basico)
        
        self.assertIsInstance(coordenadas, list)
        self.assertGreater(len(coordenadas), 0, "Deveria encontrar coordenadas")
        
        # Verifica estrutura dos dados
        for coord in coordenadas:
            self.assertIn('pos', coord)
            self.assertIn('extruding', coord)
            self.assertIn('line_number', coord)
            self.assertEqual(len(coord['pos']), 3)  # X, Y, Z
    
    def test_parse_gcode_tipos_movimento(self):
        """Testa diferencia√ß√£o entre movimentos r√°pidos e de trabalho."""
        visualizador = Visualizador3D(None)
        coordenadas = visualizador.parse_gcode(self.gcode_basico)
        
        movimentos_rapidos = [c for c in coordenadas if not c['extruding']]
        movimentos_trabalho = [c for c in coordenadas if c['extruding']]
        
        self.assertGreater(len(movimentos_rapidos), 0, 
                          "Deveria identificar movimentos r√°pidos (G0)")
        self.assertGreater(len(movimentos_trabalho), 0, 
                          "Deveria identificar movimentos de trabalho (G1)")
    
    def test_parse_gcode_vazio(self):
        """Testa comportamento com G-code vazio."""
        visualizador = Visualizador3D(None)
        coordenadas = visualizador.parse_gcode("")
        
        self.assertEqual(len(coordenadas), 0, 
                        "N√£o deveria encontrar coordenadas em G-code vazio")
    
    def test_parse_gcode_apenas_comentarios(self):
        """Testa parsing de G-code contendo apenas coment√°rios."""
        gcode_comentarios = """
; Este √© um arquivo apenas com coment√°rios
; G1 X10 Y10 Z0
; M30
"""
        visualizador = Visualizador3D(None)
        coordenadas = visualizador.parse_gcode(gcode_comentarios)
        
        self.assertEqual(len(coordenadas), 0,
                        "N√£o deveria encontrar coordenadas em coment√°rios")
    
    def test_parse_gcode_coordenadas_negativas(self):
        """Testa parsing de coordenadas negativas."""
        gcode_negativo = """
G21
G0 X-10 Y-5 Z5
G1 X-5 Y-10 Z0
G1 X0 Y0 Z0
"""
        visualizador = Visualizador3D(None)
        coordenadas = visualizador.parse_gcode(gcode_negativo)
        
        self.assertGreater(len(coordenadas), 0,
                          "Deveria processar coordenadas negativas")
        
        # Verifica valores negativos
        coordenadas_negativas = [c for c in coordenadas if any(p < 0 for p in c['pos'])]
        self.assertGreater(len(coordenadas_negativas), 0,
                          "Deveria encontrar coordenadas negativas")
    
    def test_parse_gcode_sem_coordenadas_z(self):
        """Testa parsing de comandos sem coordenada Z."""
        gcode_sem_z = """
G21
G0 X0 Y0
G1 X10 Y10
G1 X20 Y20
"""
        visualizador = Visualizador3D(None)
        coordenadas = visualizador.parse_gcode(gcode_sem_z)
        
        self.assertGreater(len(coordenadas), 0,
                          "Deveria processar comandos sem coordenada Z")
        
        # Verifica que Z mant√©m valor anterior (0.0 por padr√£o)
        for coord in coordenadas:
            x, y, z = coord['pos']
            self.assertEqual(z, 0.0, "Deveria manter Z=0 quando n√£o especificado")
    
    def test_parse_gcode_multiplicas_linhas(self):
        """Testa parsing com m√∫ltiplos comandos por linha."""
        gcode_multiplo = "G21 G90 G0 X0 Y0 Z5 G1 Z0 G1 X10 Y10"
        visualizador = Visualizador3D(None)
        coordenadas = visualizador.parse_gcode(gcode_multiplo)
        
        # Deve processar apenas o primeiro comando por linha
        self.assertGreater(len(coordenadas), 0,
                          "Deveria processar pelo menos alguns comandos")

class TestVisualizadorDependencias(unittest.TestCase):
    """
    Testes de verifica√ß√£o de depend√™ncias do visualizador.
    
    Garante que todas as bibliotecas necess√°rias est√£o dispon√≠veis.
    """
    
    def test_import_matplotlib(self):
        """Verifica se matplotlib est√° dispon√≠vel."""
        try:
            import matplotlib
            import matplotlib.pyplot as plt
            # Teste b√°sico de funcionalidade
            self.assertTrue(hasattr(plt, 'plot'))
            self.assertTrue(hasattr(plt, 'Figure'))
        except ImportError as e:
            self.fail(f"matplotlib n√£o est√° dispon√≠vel: {e}")
    
    def test_import_numpy(self):
        """Verifica se numpy est√° dispon√≠vel."""
        try:
            import numpy as np
            # Teste b√°sico de funcionalidade
            arr = np.array([1, 2, 3])
            self.assertEqual(len(arr), 3)
            self.assertEqual(arr.dtype, np.int64)
        except ImportError as e:
            self.fail(f"numpy n√£o est√° dispon√≠vel: {e}")
    
    def test_import_pillow(self):
        """Verifica se Pillow est√° dispon√≠vel."""
        try:
            from PIL import Image, ImageTk
            # Teste b√°sico de funcionalidade
            self.assertTrue(hasattr(Image, 'new'))
        except ImportError as e:
            self.fail(f"Pillow n√£o est√° dispon√≠vel: {e}")
    
    def test_import_opencv(self):
        """Verifica se OpenCV est√° dispon√≠vel."""
        try:
            import cv2
            # Teste b√°sico de funcionalidade
            self.assertTrue(hasattr(cv2, 'imread'))
        except ImportError as e:
            self.fail(f"OpenCV n√£o est√° dispon√≠vel: {e}")

class TestVisualizadorIntegracao(unittest.TestCase):
    """
    Testes de integra√ß√£o do visualizador com dados reais.
    """
    
    @unittest.skipIf(not VISUALIZADOR_DISPONIVEL, "Visualizador3D n√£o dispon√≠vel")
    def test_plotagem_gcode_valido(self):
        """Testa a plotagem completa de G-code v√°lido."""
        gcode_valido = """
G21
G90
G0 X0 Y0 Z5
G1 Z0 F1000
G1 X10 Y0 Z0
G1 X10 Y10 Z0
G1 X0 Y10 Z0
G1 X0 Y0 Z0
G0 Z5
M30
"""
        # Este teste verifica que a plotagem n√£o gera erros
        # A valida√ß√£o visual fica a cargo do usu√°rio
        visualizador = Visualizador3D(None)
        
        # N√£o deve gerar exce√ß√µes
        try:
            visualizador.plot_gcode(gcode_valido)
            plotagem_ok = True
        except Exception as e:
            plotagem_ok = False
            print(f"Erro na plotagem: {e}")
        
        self.assertTrue(plotagem_ok, "Plotagem deveria completar sem erros")

def executar_testes_visuais():
    """
    Fun√ß√£o para executar testes visuais manuais do visualizador.
    √ötil para desenvolvimento e debug.
    """
    if not VISUALIZADOR_DISPONIVEL:
        print("‚ùå Visualizador3D n√£o dispon√≠vel para testes visuais")
        return
    
    print("üé® EXECUTANDO TESTES VISUAIS DO VISUALIZADOR 3D")
    print("=" * 50)
    
    # G-codes de teste
    testes = {
        "Quadrado Simples": """
G21
G90
G0 X0 Y0 Z5
G1 Z0 F1000
G1 X10 Y0 Z0
G1 X10 Y10 Z0
G1 X0 Y10 Z0
G1 X0 Y0 Z0
G0 Z5
M30
""",
        "Padr√£o Complexo": """
G21
G90
G0 X0 Y0 Z10
G1 Z0 F500
G1 X20 Y0 Z0
G1 X20 Y15 Z1
G1 X0 Y15 Z0
G1 X0 Y0 Z0
G0 Z10
G0 X5 Y5 Z10
G1 Z0
G1 X15 Y5 Z0.5
G1 X15 Y10 Z1.5
G1 X5 Y10 Z0.5
G1 X5 Y5 Z0
G0 Z10
M30
"""
    }
    
    for nome, gcode in testes.items():
        print(f"üìä Teste Visual: {nome}")
        try:
            visualizador = Visualizador3D(None)
            visualizador.plot_gcode(gcode)
            print(f"   ‚úÖ {nome}: PLOTAGEM BEM-SUCEDIDA")
        except Exception as e:
            print(f"   ‚ùå {nome}: ERRO - {e}")

def suite():
    """Cria e retorna a suite completa de testes."""
    suite = unittest.TestSuite()
    suite.addTest(unittest.makeSuite(TestVisualizador3D))
    suite.addTest(unittest.makeSuite(TestVisualizadorDependencias))
    suite.addTest(unittest.makeSuite(TestVisualizadorIntegracao))
    return suite

if __name__ == '__main__':
    # Executa os testes automatizados
    print("üß™ INICIANDO TESTES DO VISUALIZADOR 3D")
    print("=" * 50)
    
    runner = unittest.TextTestRunner(verbosity=2)
    result = runner.run(suite())
    
    # Relat√≥rio final
    print("\n" + "=" * 50)
    print("üìä RELAT√ìRIO FINAL DE TESTES")
    print("=" * 50)
    print(f"‚úÖ Testes executados: {result.testsRun}")
    print(f"‚ö†Ô∏è  Falhas: {len(result.failures)}")
    print(f"‚ùå Erros: {len(result.errors)}")
    print(f"‚è© Pulados: {result.testsRun - len(result.failures) - len(result.errors)}")
    print("=" * 50)
    
    # Executa testes visuais se solicitado
    if '--visual' in sys.argv:
        executar_testes_visuais()
    
    # Retorna c√≥digo de sa√≠da apropriado
    sys.exit(0 if result.wasSuccessful() else 1)
    